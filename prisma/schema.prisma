// Prisma Schema for Subscription Management Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  ADMIN
  INTERNAL
  PORTAL
}

enum BillingPeriod {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  DRAFT
  QUOTATION
  CONFIRMED
  ACTIVE
  CLOSED
}

enum InvoiceStatus {
  DRAFT
  CONFIRMED
  PAID
  CANCELED
}

enum PaymentMethod {
  BANK_TRANSFER
  CREDIT_CARD
  CASH
  CHECK
  OTHER
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  password         String
  name             String
  role             Role      @default(PORTAL)
  isActive         Boolean   @default(true)
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  subscriptions            Subscription[] @relation("UserSubscriptions")
  salespersonSubscriptions Subscription[] @relation("SalespersonSubscriptions")
  auditLogs                AuditLog[]

  @@index([email])
  @@index([role])
  @@index([resetToken])
}

// ============================================================================
// PRODUCT CATALOG
// ============================================================================

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  imageUrl    String?  // Main product image URL
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  variants ProductVariant[]

  @@index([isActive])
}

model ProductVariant {
  id          String   @id @default(cuid())
  productId   String
  name        String
  sku         String   @unique
  description String?
  basePrice   Decimal  @db.Decimal(12, 2)
  imageUrl    String?  // Variant-specific image URL
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product           Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  subscriptionLines SubscriptionLine[]
  templateLines     SubscriptionTemplateLine[]

  @@index([productId])
  @@index([isActive])
}

// ============================================================================
// RECURRING PLANS
// ============================================================================

model RecurringPlan {
  id            String        @id @default(cuid())
  name          String
  billingPeriod BillingPeriod
  intervalCount Int           @default(1) // e.g., every 2 months
  description   String?
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  subscriptions Subscription[]
  templates     SubscriptionTemplate[]

  @@index([isActive])
}

// ============================================================================
// SUBSCRIPTIONS
// ============================================================================

model Subscription {
  id                   String             @id @default(cuid())
  subscriptionNumber   String             @unique
  userId               String
  planId               String
  status               SubscriptionStatus @default(DRAFT)
  startDate            DateTime?
  endDate              DateTime?
  nextBillingDate      DateTime?
  orderDate            DateTime?
  expirationDate       DateTime?
  quotationTemplate    String?            // Quotation template reference
  paymentTermDays      Int?               // Payment term in days
  paymentMethod        PaymentMethod?
  paymentDone          Boolean            @default(false)
  salespersonId        String?
  notes                String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user        User           @relation("UserSubscriptions", fields: [userId], references: [id], onDelete: Cascade)
  plan        RecurringPlan  @relation(fields: [planId], references: [id], onDelete: Restrict)
  salesperson User?          @relation("SalespersonSubscriptions", fields: [salespersonId], references: [id], onDelete: SetNull)
  lines       SubscriptionLine[]
  invoices    Invoice[]

  @@index([userId])
  @@index([planId])
  @@index([status, updatedAt])
  @@index([nextBillingDate])
  @@index([salespersonId])
}

model SubscriptionLine {
  id             String  @id @default(cuid())
  subscriptionId String
  variantId      String
  quantity       Int     @default(1)
  unitPrice      Decimal @db.Decimal(12, 2)
  discountId     String?
  taxRateId      String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  subscription Subscription   @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  variant      ProductVariant @relation(fields: [variantId], references: [id], onDelete: Restrict)
  discount     Discount?      @relation(fields: [discountId], references: [id], onDelete: SetNull)
  taxRate      TaxRate?       @relation(fields: [taxRateId], references: [id], onDelete: SetNull)

  @@index([subscriptionId])
  @@index([variantId])
}

// ============================================================================
// INVOICES
// ============================================================================

model Invoice {
  id             String        @id @default(cuid())
  invoiceNumber  String        @unique
  subscriptionId String
  status         InvoiceStatus @default(DRAFT)
  periodStart    DateTime
  periodEnd      DateTime
  issueDate      DateTime      @default(now())
  dueDate        DateTime
  subtotal       Decimal       @db.Decimal(12, 2)
  taxAmount      Decimal       @db.Decimal(12, 2)
  discountAmount Decimal       @db.Decimal(12, 2)
  total          Decimal       @db.Decimal(12, 2)
  paidAmount     Decimal       @default(0) @db.Decimal(12, 2)
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  subscription Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  lines        InvoiceLine[]
  payments     Payment[]

  @@unique([subscriptionId, periodStart]) // Critical idempotency constraint
  @@index([status, createdAt])
  @@index([subscriptionId])
  @@index([dueDate])
}

model InvoiceLine {
  id             String  @id @default(cuid())
  invoiceId      String
  description    String
  quantity       Int
  unitPrice      Decimal @db.Decimal(12, 2)
  discountAmount Decimal @default(0) @db.Decimal(12, 2)
  taxAmount      Decimal @default(0) @db.Decimal(12, 2)
  lineTotal      Decimal @db.Decimal(12, 2)
  createdAt      DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

// ============================================================================
// PAYMENTS
// ============================================================================

model Payment {
  id            String        @id @default(cuid())
  invoiceId     String
  amount        Decimal       @db.Decimal(12, 2)
  paymentMethod PaymentMethod
  reference     String?
  notes         String?
  paymentDate   DateTime      @default(now())
  createdAt     DateTime      @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([paymentDate])
}

// ============================================================================
// DISCOUNTS & TAXES
// ============================================================================

model Discount {
  id          String       @id @default(cuid())
  name        String
  type        DiscountType
  value       Decimal      @db.Decimal(12, 2)
  description String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  subscriptionLines SubscriptionLine[]
  templateLines     SubscriptionTemplateLine[]

  @@index([isActive])
}

model TaxRate {
  id          String   @id @default(cuid())
  name        String
  rate        Decimal  @db.Decimal(5, 2) // e.g., 18.00 for 18%
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subscriptionLines SubscriptionLine[]
  templateLines     SubscriptionTemplateLine[]

  @@index([isActive])
}

// ============================================================================
// SUBSCRIPTION TEMPLATES
// ============================================================================

model SubscriptionTemplate {
  id            String   @id @default(cuid())
  name          String
  validityDays  Int      @default(30)   // Expiration days from creation
  planId        String
  description   String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  plan  RecurringPlan              @relation(fields: [planId], references: [id], onDelete: Restrict)
  lines SubscriptionTemplateLine[]

  @@index([isActive])
  @@index([planId])
}

model SubscriptionTemplateLine {
  id         String  @id @default(cuid())
  templateId String
  variantId  String
  quantity   Int     @default(1)
  unitPrice  Decimal @db.Decimal(12, 2)
  discountId String?
  taxRateId  String?

  template SubscriptionTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  variant  ProductVariant       @relation(fields: [variantId], references: [id], onDelete: Restrict)
  discount Discount?            @relation(fields: [discountId], references: [id], onDelete: SetNull)
  taxRate  TaxRate?             @relation(fields: [taxRateId], references: [id], onDelete: SetNull)

  @@index([templateId])
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  entityType String   // SUBSCRIPTION, INVOICE, PAYMENT, etc.
  entityId   String   // Kept as String for polymorphic reference
  action     String   // CREATED, UPDATED, STATUS_CHANGE, etc.
  oldValue   String?  @db.Text
  newValue   String?  @db.Text
  metadata   String?  @db.Text // JSON string for additional context
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId, createdAt])
  @@index([userId])
  @@index([createdAt])
}
